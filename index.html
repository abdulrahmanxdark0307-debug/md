<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Duelist Tracker — Advanced</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles.css">
<script defer src="./app.js"></script>
</head>
<body>
  <!-- 🔐 Login Section -->
  <div id="authSection">
    <button id="discordLoginBtn">Login with Discord</button>
    <button id="logoutBtn" style="display:none;">Logout</button>
  </div>

  <div class="app" style="display:none">
    <div class="tabs" role="tablist" aria-label="Main tabs">
      <div class="tab active" data-tab="submit">Match Submission</div>
      <div class="tab" data-tab="stats">Stats & Matrix</div>
      <div class="tab" data-tab="analysis">Advanced Analysis</div>
      <div class="tab" data-tab="calc">Probability Calc</div>
      <div class="tab" data-tab="simulator">Simulator</div>
      <div class="tab" data-tab="archive">Archive</div>
      <div class="tab" data-tab="settings">Settings</div>
    </div>

    <div class="panels">

      <!-- 🧑 User Info -->
      <section id="panel-profile" class="panel">
        <h3 id="usernameDisplay">Welcome!</h3>
        <div id="pointsInfo">Points: 0</div>
      </section>

      <!-- ⚙️ Session Management -->
      <section id="panel-submit" class="panel show">
        <div id="sessionManager">
          <select id="sessionSelect"></select>
          <button onclick="createSession()">New Session</button>
          <button id="deleteSessionBtn">Delete Session</button>
        </div>

        <div id="deckSelectors">
          <label>My Deck:</label>
          <select id="deckSelect"></select>
          <label>Opponent Deck:</label>
          <select id="oppSelect"></select>
          <label>Result:</label>
          <select id="resultSelect"><option>Win</option><option>Loss</option></select>
          <label>Turn:</label>
          <select id="turnOrder"><option>1st</option><option>2nd</option></select>
          <input id="ptsAfterOverride" placeholder="Custom Points (optional)" />
          <button onclick="addMatch()">Add Match</button>
        </div>

        <table id="matchesTable">
          <thead>
            <tr>
              <th>Your Deck</th><th>Opponent Deck</th><th>Result</th><th>Turn</th><th>Before</th><th>After</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <p id="summaryLine">Matches: 0 • Points: 0 • Winrate: 0%</p>
      </section>

      <!-- 📈 Statistics -->
      <section id="panel-stats" class="panel">
        <div class="chart-container">
          <canvas id="pointsChart"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="trendChart"></canvas>
        </div>
        <table id="deckPerfTable">
          <thead><tr><th>Deck</th><th>Matches</th><th>Wins</th><th>WR%</th><th>1st WR%</th><th>2nd WR%</th></tr></thead>
          <tbody></tbody>
        </table>
        <div id="matrixContainer"></div>
      </section>

      <!-- 🧠 Advanced Analysis -->
      <section id="panel-analysis" class="panel">
        <div id="advancedAnalysis">
          <div>Average Winrate: <span id="avgWinRate">0%</span></div>
          <div>Consistency Score: <span id="consistencyScore">0</span></div>
          <div>Improvement Rate: <span id="improvementRate">0%</span></div>
          <div>Meta Adaptation: <span id="metaAdaptation">0%</span></div>
        </div>

        <table id="timeAnalysis">
          <thead><tr><th>Time</th><th>Matches</th><th>Winrate</th></tr></thead>
          <tbody></tbody>
        </table>

        <table id="sessionAnalysis">
          <thead><tr><th>Session Length</th><th>WR%</th><th>Frequency</th></tr></thead>
          <tbody></tbody>
        </table>

        <div id="strategicInsights"></div>
      </section>

      <!-- 🎲 Probability Calculator -->
      <section id="panel-calc" class="panel">
        <div id="hyperCalc">
          <input id="deckSize" placeholder="Deck size" />
          <input id="copiesRan" placeholder="Copies of card" />
          <input id="cardsDrawn" placeholder="Cards drawn" />
          <input id="oddsToHave" placeholder="Desired copies" />
          <button onclick="calculateHypergeometric()">Calculate</button>
          <div id="hyperResults"></div>
        </div>
      </section>

      <!-- 🎮 Simulator -->
      <section id="panel-simulator" class="panel">
        <textarea id="deckText" placeholder="# Your Deck"></textarea>
        <textarea id="comboText" placeholder="# Combo requirements"></textarea>
        <input id="simHandSize" value="5" />
        <input id="simTrials" value="10000" />
        <button id="simulateBtn">Simulate</button>
        <div id="simulationResult"></div>
      </section>

      <!-- 🗃️ Archive -->
      <section id="panel-archive" class="panel">
        <select id="archivePlayerSelect"></select>
        <button id="refreshArchiveBtn">Refresh</button>
        <div id="archiveContent"></div>
        <div id="archiveEmpty">Select a player to view data</div>
      </section>

    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof initializeApp === 'function') initializeApp();
    });
  </script>
</body>
</html>
