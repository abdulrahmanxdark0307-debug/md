<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Authentication</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2.38.4/dist/umd/supabase.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #dbe7ff;
            font-family: Inter, system-ui;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            text-align: center;
            padding: 40px;
        }
        .spinner {
            border: 4px solid rgba(255,255,255,0.1);
            border-left: 4px solid #7c5cff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <h2>Verifying Discord Membership...</h2>
        <p>Checking if you're in our Discord server.</p>
    </div>

    <script>
        const YOUR_DISCORD_SERVER_ID = '1429009622773268546'; // ÿßÿ≥ÿ™ÿ®ÿØŸÑ ÿ®ŸÄ ID ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±
        const YOUR_DISCORD_CLIENT_ID = '1430000600275222559'; // ÿßÿ≥ÿ™ÿ®ÿØŸÑ ÿ®ŸÄ Client ID
        const YOUR_DISCORD_CLIENT_SECRET = 'BXP2Jd_JkTqJiYt18MQpWc83slh2NmZc'; // ÿßÿ≥ÿ™ÿ®ÿØŸÑ ÿ®ŸÄ Client Secret

        async function handleDiscordCallback() {
            try {
                console.log('üîÑ Processing Discord callback...');
                
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const error = urlParams.get('error');
                
                if (error) {
                    throw new Error(`Discord authentication failed: ${error}`);
                }
                
                if (!code) {
                    throw new Error('No authorization code received');
                }
                
                console.log('‚úÖ Received authorization code');
                
                // Step 1: Exchange code for access token
                const tokenResponse = await fetch('https://discord.com/api/oauth2/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        client_id: YOUR_DISCORD_CLIENT_ID,
                        client_secret: YOUR_DISCORD_CLIENT_SECRET,
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: 'https://masterdueltracker.vercel.app/auth/callback',
                        scope: 'identify guilds',
                    }),
                });
                
                const tokenData = await tokenResponse.json();
                
                if (!tokenResponse.ok) {
                    throw new Error(`Token exchange failed: ${tokenData.error_description}`);
                }
                
                console.log('‚úÖ Got access token');
                
                // Step 2: Get user info and guilds
                const [userResponse, guildsResponse] = await Promise.all([
                    fetch('https://discord.com/api/users/@me', {
                        headers: {
                            'Authorization': `Bearer ${tokenData.access_token}`,
                        },
                    }),
                    fetch('https://discord.com/api/users/@me/guilds', {
                        headers: {
                            'Authorization': `Bearer ${tokenData.access_token}`,
                        },
                    })
                ]);
                
                const userData = await userResponse.json();
                const guildsData = await guildsResponse.json();
                
                if (!userResponse.ok || !guildsResponse.ok) {
                    throw new Error('Failed to get user data or guilds');
                }
                
                console.log('‚úÖ Got user data and guilds');
                
                // Step 3: Check if user is in your Discord server
                const isInServer = guildsData.some(guild => guild.id === YOUR_DISCORD_SERVER_ID);
                
                if (!isInServer) {
                    document.body.innerHTML = `
                        <div class="container">
                            <h2 style="color: #ff6b6b;">Access Denied</h2>
                            <p>You must be a member of our Discord server to access this tracker.</p>
                            <p>Join our server and try again.</p>
                            <button onclick="window.location.href='/'" style="
                                background: #7c5cff;
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 8px;
                                cursor: pointer;
                                margin-top: 20px;
                            ">Return to Login</button>
                        </div>
                    `;
                    return;
                }
                
                console.log('‚úÖ User is in Discord server');
                
                // Step 4: Store user session in localStorage (ÿ®ÿØŸàŸÜ Supabase)
                const userSession = {
                    discord_uid: userData.id,
                    username: userData.username,
                    discriminator: userData.discriminator,
                    avatar: userData.avatar,
                    isAuthenticated: true,
                    authenticatedAt: new Date().toISOString()
                };
                
                localStorage.setItem('discord_user_session', JSON.stringify(userSession));
                localStorage.setItem('discord_access_token', tokenData.access_token);
                
                console.log('‚úÖ Session stored, redirecting to main app...');
                
                // Redirect to main app
                setTimeout(() => {
                    window.location.href = '/';
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Discord callback error:', error);
                document.body.innerHTML = `
                    <div class="container">
                        <h2 style="color: #ff6b6b;">Authentication Failed</h2>
                        <p>${error.message}</p>
                        <button onclick="window.location.href='/'" style="
                            background: #7c5cff;
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            cursor: pointer;
                            margin-top: 20px;
                        ">Return to Login</button>
                    </div>
                `;
            }
        }

        // Start the callback process
        document.addEventListener('DOMContentLoaded', handleDiscordCallback);
    </script>
</body>
</html>
